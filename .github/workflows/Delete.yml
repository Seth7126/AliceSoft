name: Retain Only .exe Folders
on:
  workflow_dispatch: # 仅允许手动触发，防止意外自动执行

permissions:
  contents: write # 需要写权限来提交更改

jobs:
  filter-and-cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Filter directories and clean up
        run: |
          echo "Step 1: Creating safe haven..."
          # 在当前工作区之外创建一个临时目录用于存放要保留的文件
          SAFE_DIR="../safe_haven"
          mkdir -p "$SAFE_DIR"

          echo "Step 2: Finding and backing up '*.exe' folders..."
          # 查找所有名为 *.exe 的目录 (-type d)
          # 排除 .git 目录
          # 使用 -print0 处理可能包含空格的文件名
          find . -type d -name "*.exe" -not -path "./.git/*" -print0 | while IFS= read -r -d '' dir; do
            echo "Found: $dir"
            
            # 获取该文件夹的父级目录路径 (例如 ./A/B/target.exe -> ./A/B)
            parent_path=$(dirname "$dir")
            
            # 在安全目录中重建父级结构
            mkdir -p "$SAFE_DIR/$parent_path"
            
            # 复制整个 .exe 文件夹到安全目录
            cp -r "$dir" "$SAFE_DIR/$parent_path/"
          done

          echo "Step 3: Wiping repository content..."
          # 删除当前目录下除了 .git 之外的所有文件和文件夹
          # -mindepth 1 确保不删除 '.' 本身
          find . -maxdepth 1 -mindepth 1 -not -name '.git' -exec rm -rf {} +

          echo "Step 4: Restoring backup..."
          # 如果安全目录不为空，则将内容复制回来
          if [ -d "$SAFE_DIR" ] && [ "$(ls -A $SAFE_DIR)" ]; then
            cp -a "$SAFE_DIR/." .
            echo "Restoration complete."
          else
            echo "No *.exe folders were found. Repository is now empty."
          fi

      - name: Commit and Push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # 添加所有更改（包括删除的文件和恢复的文件）
          git add .
          
          # 检查是否有更改需要提交
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Cleanup: Removed all contents except '*.exe' directories"
            git push
          fi
